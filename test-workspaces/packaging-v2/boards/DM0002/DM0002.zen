load("@stdlib/interfaces.zen", "Analog", "Gpio", "Ground", "Power", "Swd", "Uart", "Usb2")
load("@stdlib/board_config.zen", "Board")
load("@stdlib/units.zen", "Voltage", "VoltageRange")

Board(
    name = "DM0002",
    layers = 4,
    layout_path = "layout",
)

# TODO: Hardware improvements
# - Add polyfuse on VBUS (0.75A): Protects USB host if target shorts 3.3V rail
# - Add ferrite bead for analog 3.3V rail: Reduces digital switching noise on sensitive circuits

RP2040 = Module("github.com/diodeinc/pcb/test-workspaces/packaging-v2/modules/RP2040.zen")
USB4105 = Module("github.com/diodeinc/pcb/test-workspaces/packaging-v2/modules/USB4105.zen")
TLV758P = Module("github.com/diodeinc/pcb/test-workspaces/packaging-v2/modules/TLV758P.zen")
Led = Module("github.com/diodeinc/pcb/test-workspaces/packaging-v2/modules/Led.zen")

PinHeader = Module("@stdlib/kicad/PinHeader.zen")
Capacitor = Module("@stdlib/generics/Capacitor.zen")
TestPoint = Module("@stdlib/generics/TestPoint.zen")
Resistor = Module("@stdlib/generics/Resistor.zen")

# Power rails
vbus_5v0 = Power("VBUS_5V0", voltage=VoltageRange("4.5 to 5.5V"))
vdd_3v3 = Power("VDD_3V3", voltage=VoltageRange("3.3V"))
gnd = Ground("GND")

# External interfaces
usb = Usb2("USB")
target_swd = Swd("SWD")
target_uart = Uart("TARGET_UART")
target_v_sense = Analog("TARGET_V_SENSE")
target_gnd_detect = Analog("TARGET_GND_DETECT")
target_reset = Gpio("TARGET_RESET")

# GPIO assignments for RP2040
vbus_det = Gpio("VBUS_DET")
gpio_15_led_orange = Gpio("LED_O1")
gpio_14_led_orange = Gpio("LED_O2")
gpio_12_led_orange = Gpio("LED_O3")
gpio_16_led_green = Gpio("LED_G")
gpio_17_led_blue = Gpio("LED_B")

# USB-C connector with ESD protection
usb_connector = USB4105(
    name = "USB_C",
    mode = "device",
    VBUS = vbus_5v0,
    USB = usb,
    GND = gnd,
)

# 3.3V LDO regulator
ldo = TLV758P(
    name = "LDO_3V3",
    input_voltage = "5V",
    output_voltage = "3.3V",
    VIN = vbus_5v0,
    VOUT = vdd_3v3,
    GND = gnd,
)

# MCU connections
mcu = RP2040(
    name = "MCU",
    vdd_3v3 = vdd_3v3,
    gnd = gnd,
    usb = usb,
    # GPIO assignments
    GPIO12 = gpio_12_led_orange,
    GPIO13 = vbus_det,
    GPIO14 = gpio_14_led_orange,
    GPIO15 = gpio_15_led_orange,
    GPIO16 = gpio_16_led_green,
    GPIO17 = gpio_17_led_blue,
    GPIO18 = target_reset,
    GPIO19 = Gpio(NET = target_swd.SWCLK),
    GPIO20 = Gpio(NET = target_swd.SWDIO),
    GPIO26_ADC0 = target_v_sense,
    GPIO27_ADC1 = target_gnd_detect,
    GPIO28_ADC2 = Analog(NET = target_uart.RX),
    GPIO29_ADC3 = Analog(NET = target_uart.TX),
)

idc_header = PinHeader(
    name = "SWD_HEADER",
    pins = 5,
    rows = 2,
    pitch = "1.27mm",
    orientation = "Vertical",
    Pin_1 = target_v_sense,
    Pin_2 = target_swd.SWDIO,
    Pin_3 = gnd,
    Pin_4 = target_swd.SWCLK,
    Pin_5 = gnd,
    Pin_6 = target_uart.RX,
    Pin_7 = Net("NC"),
    Pin_8 = target_uart.TX,
    Pin_9 = target_gnd_detect,
    Pin_10 = target_reset,
)

# Test points for power rails
TestPoint(name = "TP_VBUS", variant = "Pad_D1.5mm", P1 = vbus_5v0)
TestPoint(name = "TP_3V3", variant = "Pad_D1.5mm", P1 = vdd_3v3)
TestPoint(name = "TP_GND", variant = "Pad_D1.5mm", P1 = gnd)

# VBUS detection voltage divider (5V -> 2.94V for GPIO 13)
# Using 33k + 47k resistors for 5V * 47k/(33k+47k) = 2.94V > VIH(2.31V)
Resistor(name = "R_VBUS_DIV_H", package = "0402", value = "33kOhm", P1 = vbus_5v0, P2 = vbus_det)
Resistor(name = "R_VBUS_DIV_L", package = "0402", value = "47kOhm", P1 = vbus_det, P2 = gnd)

# GPIO-controlled Status LEDs (GPIO sources current when high, push-pull topology)
Led(name = "LED_B", color = "blue", supply_voltage = Voltage("3.3V"), p1 = gpio_17_led_blue, p2 = gnd)
Led(name = "LED_G", color = "green", supply_voltage = Voltage("3.3V"), p1 = gpio_16_led_green, p2 = gnd)
Led(name = "LED_O1", color = "orange", supply_voltage = Voltage("3.3V"), p1 = gpio_15_led_orange, p2 = gnd)
Led(name = "LED_O2", color = "orange", supply_voltage = Voltage("3.3V"), p1 = gpio_14_led_orange, p2 = gnd)
Led(name = "LED_O3", color = "orange", supply_voltage = Voltage("3.3V"), p1 = gpio_12_led_orange, p2 = gnd)

# Power indicator LED
Led(name = "LED_PWR", color = "red", supply_voltage = Voltage("3.3V"), p1 = vdd_3v3, p2 = gnd)

# Diode Logo
Component(
    name = "LOGO",
    description = "Diode Logo",
    prefix = "TP",
    footprint = File("github.com/diodeinc/pcb/test-workspaces/packaging-v2/components/logo/eda/logo.kicad_mod"),
    pin_defs = {},
    pins = {},
    dnp = True,
    skip_bom = True,
    skip_pos = True,
)
